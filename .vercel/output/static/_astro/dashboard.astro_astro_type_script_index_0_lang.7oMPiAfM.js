import{u as y}from"./auth-store.DtDsWl_t.js";import{i as E,g as k,a as L}from"./api.BoHFqtEf.js";function x(){try{const e=document.querySelector("div.mt-8 div.grid");if(!e){console.warn("No se encontró el contenedor de acciones rápidas");return}const r=e.querySelectorAll("a");if(r.length===0){console.warn("No se encontraron enlaces de acción rápida");return}r.forEach(o=>{const a=o.getAttribute("href");if(!a){console.warn("Enlace sin atributo href encontrado");return}const l=o.cloneNode(!0);if(o.parentNode)o.parentNode.replaceChild(l,o);else{console.warn("No se pudo reemplazar el enlace: parentNode es null");return}l.addEventListener("click",s=>{try{const t=y.getState();if(!t||!t.isAuthenticated){console.warn("Usuario no autenticado al intentar navegar"),s.preventDefault(),window.location.href="/login";return}console.log("Navegando a:",a)}catch(t){console.error("Error al manejar clic en acción rápida:",t)}})}),console.log("Enlaces de acción rápida configurados correctamente")}catch(e){console.error("Error al configurar los enlaces de acción rápida:",e),setTimeout(()=>{try{x()}catch(r){console.error("Error al reintentar configurar enlaces:",r)}},1e3)}}document.addEventListener("DOMContentLoaded",async()=>{try{console.log("DOM cargado, iniciando dashboard");const e=document.createElement("div");e.id="dashboard-loading",e.className="fixed top-0 left-0 w-full bg-blue-100 text-blue-700 p-2 text-center z-50",e.textContent="Cargando dashboard...",document.body.prepend(e);const r=y.getState();if(!r){console.error("No se pudo acceder al store de autenticación"),window.location.href="/login?error=auth_store_not_found";return}try{console.log("Estado antes de validar sesión:",{hasUser:!!r.user,hasToken:!!r.token,isAuthenticated:r.isAuthenticated});const s=await r.validateSession(),t=y.getState();if(console.log("Estado después de validar sesión:",{hasUser:!!t.user,hasToken:!!t.token,isAuthenticated:t.isAuthenticated,validationResult:s}),s===!1){console.error("Validación de sesión fallida - Token inválido o expirado"),window.location.href="/login?error=session_expired";return}if(s===!0)console.log("Sesión validada correctamente");else if(s===null){console.log("No se pudo verificar la autenticación debido a problemas de conexión");const i=document.createElement("div");i.className="fixed top-0 left-0 w-full bg-yellow-100 text-yellow-700 p-2 text-center z-50",i.textContent="No se pudo verificar la conexión con el servidor. Algunas funciones podrían no estar disponibles.",document.body.prepend(i),setTimeout(()=>{i.remove()},5e3)}console.log("Continuando con la sesión actual")}catch(s){console.error("Error al validar sesión:",s);const t=document.createElement("div");t.className="fixed top-0 left-0 w-full bg-yellow-100 text-yellow-700 p-2 text-center z-50",t.textContent="Error al conectar con el servidor. Algunas funciones podrían no estar disponibles.",document.body.prepend(t),setTimeout(()=>{t.remove()},5e3)}const o=y.getState();if(console.log("Estado completo después de validación:",{hasUser:!!o.user,hasToken:!!o.token,isAuthenticated:o.isAuthenticated,isLoading:o.isLoading}),o.isAuthenticated)console.log("Usuario autenticado según el store, continuando con la carga del dashboard");else{console.log("Usuario no autenticado según el store, redirigiendo a login"),setTimeout(()=>{window.location.href="/login?error=not_authenticated"},500);return}const a=r.user;if(a){let s="Usuario";a.first_name&&a.last_name?s=`${a.first_name} ${a.last_name}`:a.first_name?s=a.first_name:a.name?s=a.name:a.email&&(s=a.email);const t=document.querySelector("h2.text-3xl.font-bold.text-gray-900");t?t.textContent=`Bienvenido, ${s}`:console.warn("No se encontró el elemento del título del PageHeader")}x(),await v(),await w();const l=document.getElementById("dashboard-loading");l&&l.remove(),console.log("Dashboard inicializado correctamente")}catch(e){console.error("Error al inicializar el dashboard:",e);const r=document.getElementById("error-container");r&&(r.classList.remove("hidden"),r.textContent=`Ocurrió un error al cargar el dashboard: ${e instanceof Error?e.message:"Error desconocido"}. Por favor, intenta recargar la página.`);const o=document.getElementById("dashboard-loading");o&&o.remove();try{x()}catch(a){console.error("Error al configurar acciones rápidas:",a)}}});async function v(){console.log("Iniciando carga de vehículos");const e=document.getElementById("vehicles-container"),r=document.getElementById("loading-vehicles"),o=document.getElementById("no-vehicles"),a=document.getElementById("error-loading-vehicles"),l=document.getElementById("vehicle-count"),s=document.getElementById("error-container");if(!e||!r||!o||!a||!l){console.error("No se encontraron elementos del DOM necesarios para cargar vehículos"),s&&(s.classList.remove("hidden"),s.textContent="Error: No se encontraron elementos necesarios en la página. Por favor, recarga la página.");return}r.classList.remove("hidden"),o.classList.add("hidden"),a.classList.add("hidden");try{console.log("Verificando autenticación para cargar vehículos");let t=!1;try{const n=y.getState();n&&n.isAuthenticated?t=!0:t=(await E()).isAuthenticated===!0,console.log("Resultado de autenticación:",t)}catch(n){console.error("Error al verificar autenticación para cargar vehículos:",n),r.classList.add("hidden"),a.classList.remove("hidden"),a.innerHTML=`
                        <p>Error al verificar la autenticación. <button id="retry-auth" class="text-blue-600 hover:underline">Reintentar</button></p>
                    `;const c=document.getElementById("retry-auth");c&&c.addEventListener("click",v),l.textContent="0";return}if(!t){console.error("No hay autenticación para cargar vehículos"),r.classList.add("hidden"),a.classList.remove("hidden"),a.innerHTML=`
                        <p>No estás autenticado. <a href="/login" class="text-blue-600 hover:underline">Iniciar sesión</a></p>
                    `,l.textContent="0";return}console.log("Obteniendo vehículos del usuario");let i=[],g=0;const m=2;async function f(){try{const n=await k();return Array.isArray(n)?n:(console.warn("La respuesta de vehículos no es un array, intentando convertir:",n),n&&typeof n=="object"?Object.values(n):[])}catch(n){if(console.error(`Error al obtener vehículos (intento ${g+1}/${m+1}):`,n),g<m)return g++,console.log(`Reintentando obtener vehículos (intento ${g+1}/${m+1})...`),await new Promise(c=>setTimeout(c,1e3)),f();throw n}}try{i=await f(),console.log("Vehículos obtenidos:",i)}catch(n){console.error("Error al obtener vehículos después de reintentos:",n),r.classList.add("hidden"),a.classList.remove("hidden"),a.innerHTML=`
                        <p>Error al cargar los vehículos. <button id="retry-vehicles" class="text-blue-600 hover:underline">Reintentar</button></p>
                    `;const c=document.getElementById("retry-vehicles");c&&c.addEventListener("click",v),l.textContent="0";return}console.log("Ocultando indicador de carga"),r.classList.add("hidden");const h=[];for(let n=0;n<e.children.length;n++){const c=e.children[n];c.id!=="loading-vehicles"&&c.id!=="no-vehicles"&&c.id!=="error-loading-vehicles"&&h.push(c)}if(h.forEach(n=>{try{e.removeChild(n)}catch(c){console.warn("Error al eliminar hijo del contenedor:",c)}}),i&&i.length>0){console.log("Mostrando",i.length,"vehículos"),l.textContent=i.length.toString(),o.classList.add("hidden"),a.classList.add("hidden");const n=i.slice(0,3),c=document.createDocumentFragment();if(n.forEach(u=>{if(u&&typeof u=="object")try{const p=C(u);c.appendChild(p)}catch(p){console.error("Error al crear tarjeta de vehículo:",p)}else console.warn("Vehículo inválido encontrado:",u)}),e.appendChild(c),i.length>3)try{const u=P(i.length-3);e.appendChild(u)}catch(u){console.error('Error al crear tarjeta de "Ver más":',u)}}else{console.log("No se encontraron vehículos para este usuario"),l.textContent="0",a.classList.add("hidden");try{const n=document.createElement("div");n.className="col-span-full text-center py-8 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm",n.innerHTML=`
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <svg class="w-16 h-16 text-primary-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">No tienes vehículos registrados</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Registra tu primer vehículo para recibir alertas de Pico y Placa</p>
                                <a href="/user/register-vehicle" class="inline-flex items-center px-6 py-3 text-base font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 shadow-md transition-all duration-200">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Registrar mi primer vehículo
                                </a>
                            </div>
                        `,e.appendChild(n),o.classList.add("hidden")}catch(n){console.error("Error al mostrar mensaje de no vehículos:",n),o.classList.remove("hidden")}}}catch(t){if(console.error("Error loading vehicles:",t),r&&a&&l){r.classList.add("hidden"),a.classList.remove("hidden"),a.innerHTML=`
                        <p>Error inesperado al cargar vehículos. <button id="retry-vehicles-error" class="text-blue-600 hover:underline">Reintentar</button></p>
                    `;const i=document.getElementById("retry-vehicles-error");i&&i.addEventListener("click",v),l.textContent="0"}}console.log("Finalizada la carga de vehículos")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("reload-vehicles");e&&e.addEventListener("click",v)});function C(e){if(!e||typeof e!="object"){console.error("Datos de vehículo inválidos:",e);const o=document.createElement("div");return o.className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 shadow-sm",o.textContent="Error: Datos de vehículo inválidos",o}const r=document.createElement("div");r.className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow";try{const o=(e.Placa||e.placa||"Sin placa").toUpperCase(),a=e.Modelo||e.modelo||"",l=e.Tipo||e.tipo||"Desconocido",s=e.id||e.ID||"";let t="Desconocido",i="bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300";try{const g=new Date,m=g.getDay();if(m===0||m===6)t="Libre",i="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";else{const f=o.trim().slice(-1),h=parseInt(f);if(isNaN(h))t="Verificar",i="bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300";else{let n=!1;switch(m){case 1:n=[6,7,8,9,0].includes(h);break;case 2:n=[1,2,3,4,5].includes(h);break;case 3:n=[6,7,8,9,0].includes(h);break;case 4:n=[1,2,3,4,5].includes(h);break;case 5:g.getDate()%2===0?n=[1,2,3,4,5].includes(h):n=[6,7,8,9,0].includes(h);break}n?(t="Restringido",i="bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"):(t="Libre",i="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300")}}}catch(g){console.error("Error al determinar estado de Pico y Placa:",g),t="Error",i="bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}r.innerHTML=`
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">${o}</h4>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${l.toLowerCase().includes("carro")?"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300":l.toLowerCase()==="moto"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300":"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300"}">
                            ${l.replace("_"," ")}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">${a||"Vehículo registrado"}</div>
                    <div class="flex justify-between items-center">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${i}">
                            ${t}
                        </span>
                        <a href="/user/vehicle-details/${s}" class="text-xs text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">
                            Ver detalles
                        </a>
                    </div>
                `,r.addEventListener("click",g=>{const m=g.target;m&&!m.closest("a")&&(window.location.href=`/user/vehicle-details/${s}`)}),r.style.cursor="pointer"}catch(o){console.error("Error al crear la tarjeta del vehículo:",o),r.innerHTML=`
                    <div class="text-center text-red-600 dark:text-red-400">
                        <p>Error al mostrar el vehículo</p>
                        <p class="text-xs">${o instanceof Error?o.message:"Error desconocido"}</p>
                    </div>
                `}return r}function P(e){(typeof e!="number"||isNaN(e)||e<0)&&(e=0);const r=document.createElement("div");r.className="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4 flex items-center justify-center shadow-sm hover:shadow-md transition-all duration-200";try{r.innerHTML=`
                    <a href="/user/vehicles" class="text-center">
                        <div class="text-gray-400 dark:text-gray-500 mb-2">
                            <svg class="mx-auto h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">+${e} vehículos más</p>
                        <p class="text-xs text-gray-500 dark:text-gray-500">Ver todos</p>
                    </a>
                `}catch(o){console.error('Error al crear la tarjeta de "Ver más":',o),r.textContent="Ver más vehículos"}return r}async function w(){console.log("Iniciando carga de información de Pico y Placa");const e=document.getElementById("pico-status"),r=document.getElementById("next-restriction"),o=document.getElementById("loading-pico-placa"),a=document.getElementById("error-pico-placa"),l=document.getElementById("error-container");if(!e||!r){console.error("No se encontraron elementos del DOM necesarios para Pico y Placa"),l&&(l.classList.remove("hidden"),l.textContent="Error: No se encontraron elementos necesarios para mostrar información de Pico y Placa. Por favor, recarga la página.");return}o&&o.classList.remove("hidden"),a&&a.classList.add("hidden");try{console.log("Verificando autenticación para cargar información de Pico y Placa");let s=!1;try{const d=y.getState();d&&d.isAuthenticated?s=!0:s=(await E()).isAuthenticated===!0,console.log("Resultado de autenticación para Pico y Placa:",s)}catch(d){throw console.error("Error al verificar autenticación para Pico y Placa:",d),new Error("Error de autenticación: "+(d instanceof Error?d.message:"Error desconocido"))}if(!s)throw console.error("No hay autenticación para cargar información de Pico y Placa"),new Error("No estás autenticado. Por favor, inicia sesión nuevamente.");let t=null,i=0;const g=2;async function m(){try{const d=await L();if(!d||!d.item1||!d.item2)throw console.warn("La respuesta de reglas no es válida:",d),new Error("Reglas de Pico y Placa no válidas");return d}catch(d){if(console.error(`Error al obtener reglas (intento ${i+1}/${g+1}):`,d),i<g)return i++,console.log(`Reintentando obtener reglas (intento ${i+1}/${g+1})...`),await new Promise(b=>setTimeout(b,1e3)),m();throw d}}try{t=await m(),console.log("Reglas de Pico y Placa obtenidas:",t)}catch(d){throw console.error("Error al obtener reglas después de reintentos:",d),new Error("No se pudieron obtener las reglas de Pico y Placa: "+(d instanceof Error?d.message:"Error desconocido"))}o&&o.classList.add("hidden");const f=new Date,h=f.getDay();if(h===0||h===6){e.textContent="Libre",e.className="text-3xl font-bold text-green-600 dark:text-green-400",r.textContent="Lunes";return}let c=[],u,p="";switch(h){case 1:c=[...t.item1],u="Martes";break;case 2:c=[...t.item2],u="Miércoles";break;case 3:c=[...t.item1],u="Jueves";break;case 4:c=[...t.item2],u="Viernes";break;case 5:c=f.getDate()%2===0?[...t.item2]:[...t.item1],u="Lunes";break;default:c=[],u="Lunes"}Array.isArray(c)&&c.length>0&&(p=c.join(", ")),e.textContent="Activo",e.className="text-3xl font-bold text-red-600 dark:text-red-400",r.innerHTML=`${u} <span class="text-sm font-normal">(Hoy: ${p})</span>`,console.log("Información de Pico y Placa cargada correctamente")}catch(s){if(console.error("Error loading Pico y Placa info:",s),console.error("Detalles del error:",s instanceof Error?s.message:"Error desconocido"),o&&o.classList.add("hidden"),a){a.classList.remove("hidden"),a.innerHTML=`
                        <p>Error al cargar información de Pico y Placa. <button id="retry-pico-placa" class="text-blue-600 hover:underline">Reintentar</button></p>
                        <p class="text-xs text-red-500">${s instanceof Error?s.message:"Error desconocido"}</p>
                    `;const t=document.getElementById("retry-pico-placa");t&&t.addEventListener("click",w)}e&&(e.textContent="Error",e.className="text-3xl font-bold text-gray-600 dark:text-gray-400"),r&&(r.textContent="Error al cargar")}}
