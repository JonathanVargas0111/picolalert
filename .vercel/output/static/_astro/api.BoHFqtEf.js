function m(e){return e?`/auth/login/${e}`:"/auth/login"}var u="/",y=(e,r)=>(e.endsWith(u)&&(e=e.slice(0,-1)),r.startsWith(u)||(r=u+r),e+r),b=(e,r,t)=>{let o=e.pathname===u?r:y(e.pathname,r),s=new globalThis.URL(o,e);if(t)for(let[i,a]of Object.entries(S(t)))if(a&&typeof a=="object"&&!Array.isArray(a))for(let[n,l]of Object.entries(a))s.searchParams.set(`${i}[${n}]`,String(l));else s.searchParams.set(i,a);return s};function w(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function _(e){if(!(typeof e!="object"||!e)){if(w(e)){let r=e.headers.get("Content-Type")?.toLowerCase();if(r?.startsWith("application/json")||r?.startsWith("application/health+json")){let t=await e.json();if(!e.ok||"errors"in t)throw t;return"data"in t?t.data:t}if(r?.startsWith("text/html")||r?.startsWith("text/plain")){let t=await e.text();if(!e.ok)throw t;return t}return e.status===204?null:e}if("errors"in e)throw e;return"data"in e?e.data:e}}var k=async(e,r,t=globalThis.fetch)=>(r.headers=typeof r.headers=="object"&&!Array.isArray(r.headers)?r.headers:{},t(e,r).then(o=>_(o).catch(s=>{let i={errors:s&&typeof s=="object"&&"errors"in s?s.errors:s,response:o};return s&&typeof s=="object"&&"data"in s&&(i.data=s.data),Promise.reject(i)}))),f={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL,logger:globalThis.console},T=(e,r={})=>{let t=r.globals?{...f,...r.globals}:f;return{globals:t,url:new t.URL(e),with(o){return{...this,...o(this)}}}};function E(e,r={}){return()=>{let t=m(r.provider),o=e;return"otp"in r&&(o.otp=r.otp),o.mode=r.mode??"cookie",{path:t,method:"POST",body:JSON.stringify(o)}}}function h(e){return["directus_access","directus_activity","directus_collections","directus_comments","directus_fields","directus_files","directus_folders","directus_migrations","directus_permissions","directus_policies","directus_presets","directus_relations","directus_revisions","directus_roles","directus_sessions","directus_settings","directus_users","directus_webhooks","directus_dashboards","directus_panels","directus_notifications","directus_shares","directus_flows","directus_operations","directus_translations","directus_versions","directus_extensions"].includes(e)}var j=(e,r,t)=>()=>{let o=String(e);if(h(o))throw new Error("Cannot use createItem for core collections");return{path:`/items/${o}`,params:t??{},body:JSON.stringify(r),method:"POST"}},P=(e,r)=>()=>({path:"/users",params:r??{},body:JSON.stringify(e),method:"POST"}),R=e=>{let r=(t,o=[])=>{if(typeof t=="object"){let s=[];for(let i in t){let a=t[i]??[];if(Array.isArray(a))for(let n of a)s.push(r(n,[...o,i]));else if(typeof a=="object")for(let n of Object.keys(a)){let l=a[n];for(let g of l)s.push(r(g,[...o,`${i}:${n}`]))}}return s.flatMap(i=>i)}return[...o,String(t)].join(".")};return e.flatMap(t=>r(t))},S=e=>{let r={};Array.isArray(e.fields)&&e.fields.length>0&&(r.fields=R(e.fields).join(",")),e.filter&&Object.keys(e.filter).length>0&&(r.filter=JSON.stringify(e.filter)),e.search&&(r.search=e.search),"sort"in e&&e.sort&&(r.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(r.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(r.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(r.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(r.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(r.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(r.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(r.groupBy=e.groupBy.join(","));for(let[t,o]of Object.entries(e))t in r||(typeof o=="string"||typeof o=="number"||typeof o=="boolean"?r[t]=String(o):r[t]=JSON.stringify(o));return r},v=(e,r)=>{if(e.length===0)throw new Error(r)},O=(e,r)=>{if(h(String(e)))throw new Error(r)},p=(e,r)=>()=>(v(String(e),"Collection cannot be empty"),O(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:r??{},method:"GET"}),A={},U=(e={})=>r=>{let t={...A,...e};return{async request(o){let s=o();if(s.headers||(s.headers={}),"Content-Type"in s.headers?s.headers["Content-Type"]==="multipart/form-data"&&delete s.headers["Content-Type"]:s.headers["Content-Type"]="application/json","getToken"in this&&!("Authorization"in s.headers)){let l=await this.getToken();l&&(s.headers.Authorization=`Bearer ${l}`)}let i=b(r.url,s.path,s.params),a={method:s.method??"GET",headers:s.headers??{}};"credentials"in t&&(a.credentials=t.credentials),s.body&&(a.body=s.body),s.onRequest&&(a=await s.onRequest(a)),t.onRequest&&(a=await t.onRequest(a));let n=await k(i.toString(),a,r.globals.fetch);return"onResponse"in s&&(n=await s.onResponse(n,a)),"onResponse"in e&&(n=await e.onResponse(n,a)),n}}};const x="https://directus.bryanmedin4.com",c=T(x).with(U()),d=1e4;async function C(e,r){try{console.log("Intentando autenticar con Directus:",{email:e});const t=c.request(E({email:e,password:r})),o=new Promise((i,a)=>{setTimeout(()=>a(new Error("Tiempo de espera agotado al autenticar")),d)}),s=await Promise.race([t,o]);if(console.log("Resultado de autenticación:",{success:!0,hasUser:!!s.user,hasToken:!!s.access_token,hasRefreshToken:!!s.refresh_token,expires:s.expires}),!s||!s.access_token)throw new Error("Respuesta de autenticación inválida");return{success:!0,data:{access_token:s.access_token,refresh_token:s.refresh_token,expires:s.expires},user:s.user||{email:e},token:s.access_token}}catch(t){return console.error("Error de autenticación:",t),{success:!1,error:t.message||"Error al autenticar usuario"}}}async function q(){try{return await c.request(p("Vehiculo"))||[]}catch(e){return console.error("Error al obtener vehículos:",e),[]}}async function D(){try{const e={item1:["6","7","8","9","0"],item2:["1","2","3","4","5"]};return console.log("Reglas de Pico y Placa obtenidas:",e),e}catch(e){return console.error("Error al obtener reglas de pico y placa:",e),{item1:["6","7","8","9","0"],item2:["1","2","3","4","5"]}}}async function N(){try{return await c.logout(),{success:!0}}catch(e){return console.error("Error al cerrar sesión:",e),{success:!1,error:e.message||"Error al cerrar sesión"}}}async function I(e,r){try{console.log("Creando vehículo en Directus:",{placa:e,tipo:r});const t=c.request(j("Vehiculo",{Placa:e,Tipo:r})),o=new Promise((i,a)=>{setTimeout(()=>a(new Error("Tiempo de espera agotado al crear vehículo")),d)}),s=await Promise.race([t,o]);return console.log("Vehículo creado correctamente:",s),{success:!0,data:s}}catch(t){return console.error("Error al crear vehículo:",t),{success:!1,error:t.message||"Error al crear vehículo"}}}async function J(e){try{if(console.log("Creando usuario con SDK de Directus:",{...e,password:"***OCULTA***"}),!e.email||!e.password)throw new Error("El email y la contraseña son obligatorios");const r={email:e.email,password:e.password,first_name:e.first_name||"",role:"4bf867c2-ea16-4c47-a042-efe0b39ecce9"},t=c.request(P(r)),o=new Promise((i,a)=>{setTimeout(()=>a(new Error("Tiempo de espera agotado al crear usuario")),d)}),s=await Promise.race([t,o]);return console.log("Usuario creado correctamente con SDK de Directus:",{...s,password:"***OCULTA***"}),{success:!0,data:s,message:"Usuario creado exitosamente"}}catch(r){console.error("Error al crear usuario con SDK de Directus:",r);let t="Error desconocido al crear usuario";return r&&r.errors&&Array.isArray(r.errors)&&r.errors.length>0?(t=r.errors[0].message||"Error desconocido",t.includes("Duplicate entry")||t.includes("already exists")||t.includes("has to be unique")?t="El correo electrónico ya está registrado":t.includes("validation")||t.includes("Validation")?t="Error de validación: "+t:(t.includes("permission")||t.includes("Permission")||t.includes("FORBIDDEN"))&&(t="No tienes permisos para crear usuarios")):r.message&&(t=r.message,r.message.includes("Tiempo de espera agotado")&&(t="Tiempo de espera agotado al crear el usuario. Inténtalo de nuevo.")),{success:!1,error:t}}}async function L(e=null){try{console.log("Verificando autenticación con Directus");const r=c.request(p("Vehiculo",{limit:1})),t=new Promise((o,s)=>{setTimeout(()=>s(new Error("Tiempo de espera agotado")),d)});return await Promise.race([r,t]),console.log("Usuario autenticado correctamente"),{isAuthenticated:!0,tokenRefreshed:!1}}catch(r){if(console.error("Error al verificar autenticación:",r),r&&(r.message?.includes("token")||r.message?.includes("auth")||r.status===401||r.status===403)){if(console.log("Error de autenticación detectado, token posiblemente expirado"),e){console.log("Intentando refrescar token automáticamente");try{const t=await c.refresh(e);if(t&&t.access_token)return console.log("Token refrescado automáticamente con éxito"),{isAuthenticated:!0,tokenRefreshed:!0,newToken:t.access_token,newRefreshToken:t.refresh_token,expires:t.expires}}catch(t){console.error("Error al refrescar token automáticamente:",t)}}return{isAuthenticated:!1,tokenRefreshed:!1}}return console.log("Error de conexión o servidor, no se pudo verificar la autenticación"),{isAuthenticated:null,tokenRefreshed:!1}}}export{D as a,I as b,J as c,C as d,q as g,L as i,N as l};
