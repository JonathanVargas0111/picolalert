<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visor de Logs de PicoAlert</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .filter-group {
      margin-right: 15px;
    }
    select, input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .log-debug { color: #6c757d; }
    .log-info { color: #0275d8; }
    .log-warn { color: #f0ad4e; }
    .log-error { color: #d9534f; }
    .details-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .details-expanded {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .no-logs {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
    #log-count {
      margin-left: 10px;
      font-weight: normal;
      font-size: 0.8em;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Visor de Logs de PicoAlert <span id="log-count"></span></h1>
  
  <div class="controls">
    <div class="filter-group">
      <label for="level-filter">Nivel:</label>
      <select id="level-filter">
        <option value="">Todos</option>
        <option value="DEBUG">DEBUG</option>
        <option value="INFO">INFO</option>
        <option value="WARN">WARN</option>
        <option value="ERROR">ERROR</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="category-filter">Categoría:</label>
      <select id="category-filter">
        <option value="">Todas</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="search-filter">Buscar:</label>
      <input type="text" id="search-filter" placeholder="Texto a buscar...">
    </div>
    
    <button id="refresh-logs">Actualizar</button>
    <button id="export-logs">Exportar JSON</button>
    <button id="clear-logs">Limpiar Logs</button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Fecha/Hora</th>
        <th>Nivel</th>
        <th>Categoría</th>
        <th>Mensaje</th>
        <th>Detalles</th>
      </tr>
    </thead>
    <tbody id="logs-body">
      <!-- Los logs se cargarán dinámicamente -->
    </tbody>
  </table>

  <script>
    // Función para obtener los logs de localStorage
    function getLogs() {
      try {
        const logsData = localStorage.getItem('picoalert-logs');
        return logsData ? JSON.parse(logsData) : [];
      } catch (error) {
        console.error('Error al recuperar logs:', error);
        return [];
      }
    }

    // Elementos del DOM
    const logsBody = document.getElementById('logs-body');
    const levelFilter = document.getElementById('level-filter');
    const categoryFilter = document.getElementById('category-filter');
    const searchFilter = document.getElementById('search-filter');
    const exportButton = document.getElementById('export-logs');
    const clearButton = document.getElementById('clear-logs');
    const refreshButton = document.getElementById('refresh-logs');
    const logCountElement = document.getElementById('log-count');

    // Función para cargar y mostrar los logs
    function loadLogs() {
      const logs = getLogs();
      logCountElement.textContent = `(${logs.length} registros)`;
      
      // Obtener valores de filtros
      const levelValue = levelFilter.value.toUpperCase();
      const categoryValue = categoryFilter.value;
      const searchValue = searchFilter.value.toLowerCase();
      
      // Filtrar logs
      const filteredLogs = logs.filter(log => {
        const levelMatch = !levelValue || log.level === levelValue;
        const categoryMatch = !categoryValue || log.category === categoryValue;
        
        const searchMatch = !searchValue || 
          log.message.toLowerCase().includes(searchValue) || 
          (log.data && JSON.stringify(log.data).toLowerCase().includes(searchValue));
        
        return levelMatch && categoryMatch && searchMatch;
      });
      
      // Actualizar tabla de logs
      if (logsBody) {
        logsBody.innerHTML = '';
        
        if (filteredLogs.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="5" class="no-logs">No se encontraron logs que coincidan con los filtros.</td>`;
          logsBody.appendChild(row);
        } else {
          filteredLogs.forEach(log => {
            const row = document.createElement('tr');
            
            // Formatear fecha
            const date = new Date(log.timestamp);
            const formattedDate = date.toLocaleString();
            
            // Clase CSS según nivel
            let levelClass = '';
            switch (log.level) {
              case 'DEBUG':
                levelClass = 'log-debug';
                break;
              case 'INFO':
                levelClass = 'log-info';
                break;
              case 'WARN':
                levelClass = 'log-warn';
                break;
              case 'ERROR':
                levelClass = 'log-error';
                break;
              default:
                levelClass = 'log-debug';
                break;
            }
            
            // Formatear datos adicionales
            let dataContent = '';
            if (log.data) {
              try {
                const dataStr = typeof log.data === 'string' 
                  ? log.data 
                  : JSON.stringify(log.data, null, 2);
                dataContent = `<div class="details-cell">${dataStr}</div>`;
              } catch (e) {
                dataContent = `<div class="details-cell">Error al formatear datos: ${e.message}</div>`;
              }
            }
            
            row.innerHTML = `
              <td>${formattedDate}</td>
              <td class="${levelClass}">${log.level}</td>
              <td>${log.category}</td>
              <td>${log.message}</td>
              <td>${dataContent}</td>
            `;
            
            logsBody.appendChild(row);
          });
          
          // Hacer que los detalles sean expandibles al hacer clic
          document.querySelectorAll('.details-cell').forEach(cell => {
            cell.addEventListener('click', function() {
              this.classList.toggle('details-expanded');
            });
          });
        }
      }
      
      // Actualizar categorías disponibles
      updateCategories(logs);
    }
    
    // Actualizar lista de categorías disponibles
    function updateCategories(logs) {
      // Obtener categorías únicas
      const categories = [...new Set(logs.map(log => log.category))].sort();
      
      // Limpiar opciones actuales excepto la primera (Todas)
      while (categoryFilter.options.length > 1) {
        categoryFilter.remove(1);
      }
      
      // Añadir nuevas opciones
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }
    
    // Exportar logs como archivo JSON
    exportButton.addEventListener('click', function() {
      const logs = getLogs();
      const dataStr = JSON.stringify(logs, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      
      const exportFileName = `picoalert-logs-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.click();
    });
    
    // Limpiar logs
    clearButton.addEventListener('click', function() {
      if (confirm('¿Estás seguro de que deseas eliminar todos los logs? Esta acción no se puede deshacer.')) {
        localStorage.removeItem('picoalert-logs');
        loadLogs();
      }
    });
    
    // Actualizar logs
    refreshButton.addEventListener('click', loadLogs);
    
    // Filtros
    levelFilter.addEventListener('change', loadLogs);
    categoryFilter.addEventListener('change', loadLogs);
    searchFilter.addEventListener('input', loadLogs);
    
    // Cargar logs al iniciar
    document.addEventListener('DOMContentLoaded', loadLogs);
    
    // Cargar logs inmediatamente si el DOM ya está listo
    if (document.readyState === 'interactive' || document.readyState === 'complete') {
      loadLogs();
    }
  </script>
</body>
</html>